#!/bin/sh

SCRIPT=$(readlink $0 || true)
if [ -z $SCRIPT ]; then
    SCRIPT=$0
fi

SCRIPT_DIR="$(cd `dirname "$SCRIPT"` && pwd -P)"
RELEASE_ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd -P)"
REL_NAME="riak-cs"

RPC_HOP=$RELEASE_ROOT_DIR/bin/$REL_NAME
# nodetool has a 60 sec value hardcoded for RPC timeout, with no easy
# way to supply an 'infinity' from a script.  Much as I hate to
# pretend 60 sec is long enough, here's a TODO note to have it fixed
# (best would be to patch relx/nodetool upstream).  The only call
# affected is `riak-cs-admin cluster-info`.
RPC_HOP_INF=$RPC_HOP

usage() {
    echo "Usage: $SCRIPT { version | status | gc | access | storage | stanchion | cluster-info | cleanup-orphan-multipart | audit-bucket-ownership}"
}

# Check the first argument for instructions
case "$1" in
    version)
        shift
        $RPC_HOP rpc riak_cs_console version
        ;;
    status)
        shift
        $RPC_HOP rpc riak_cs_console status
        ;;
    gc)
        shift
        case "$1" in
            batch|status|pause|resume|cancel|set-interval|set-leeway|earliest-keys)
                $RPC_HOP rpc riak_cs_gc_console "$@"
                ;;
            *)
                echo "Usage: $SCRIPT gc { batch [<leeway_seconds>|--help] | status | pause | resume | cancel |"
                echo "                          set-interval <interval_seconds> | set-leeway <leeway_seconds> |"
                echo "                          earliest-keys [bag names]}"
                exit 1
                ;;
        esac
        ;;
    storage)
        shift
        case "$1" in
            batch|status|pause|resume|cancel)
                $RPC_HOP rpc riak_cs_storage_console "$@"
                ;;
            *)
                echo "Usage: $SCRIPT storage $1 { batch | status | pause | resume | cancel }"
                exit 1
                ;;
        esac
        ;;
    access)
        shift
        case "$1" in
            flush)
                $RPC_HOP rpc riak_cs_access_console flush "$@"
                ;;
            *)
                echo "Usage: $SCRIPT access $1 { flush }"
                exit 1
                ;;
        esac
        ;;
    stanchion)
        shift
        case "$1" in
            switch|show)
                $RPC_HOP rpc riak_cs_stanchion_console "$@"
                ;;
            *)
                echo "Usage: $SCRIPT stanchion $1 { switch HOST PORT | show }"
                exit 1
                ;;
        esac
        ;;
    cluster[_-]info)
        if [ $# -lt 2 ]; then
            echo "Usage: $SCRIPT $1 <output_file>"
            exit 1
        fi
        shift

        $RPC_HOP_INF rpc riak_cs_console cluster_info "$@"
        ;;
    cleanup[_-]orphan[_-]multipart)
        shift

        $RPC_HOP rpc riak_cs_console cleanup_orphan_multipart "$@"
        ;;
    audit[_-]bucket[_-]ownership)
        shift
        $RPC_HOP rpc riak_cs_console audit_bucket_ownership "$@"
        ;;
    *)
        usage
        exit 1
        ;;
esac
